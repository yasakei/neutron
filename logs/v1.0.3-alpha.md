# Neutron v1.0.3-alpha Changelog

**Release Date:** October 7, 2025  
**Focus:** Windows MSYS/MinGW Build Support & Cross-Platform Compatibility

---

## Overview

Version 1.0.3-alpha is a maintenance release focused on improving Windows build support, specifically for MSYS2/MinGW64 environments. This release eliminates the hard dependency on the external `dlfcn-win32` package by providing an internal Windows compatibility shim, making Neutron easier to build on Windows while maintaining full compatibility with Linux and macOS.

---

## Major Changes

### Windows Build System Improvements

#### 1. Optional dlfcn-win32 Dependency
**Problem:** Previous Windows builds required the `dlfcn-win32` package from vcpkg, which added complexity and potential build failures.

**Solution:** 
- Made `dlfcn-win32` completely optional
- CMake now attempts to find `dlfcn-win32` but continues if not found
- Automatically falls back to internal compatibility shim
- Users can still use `dlfcn-win32` if preferred (detected automatically)

**Files Modified:**
- `CMakeLists.txt` - Changed `find_package(dlfcn-win32 CONFIG REQUIRED)` to `find_package(dlfcn-win32 CONFIG)`

#### 2. Windows dlopen Compatibility Shim
**Implementation:** Created a minimal POSIX-style dlopen API implementation for Windows using native Windows API.

**New Files:**
- `include/cross-platfrom/dlfcn_compat.h` - Header providing dlopen/dlsym/dlclose prototypes and RTLD_* macros
- `src/platform/dlfcn_compat_win.cpp` - Implementation using LoadLibrary/GetProcAddress/FreeLibrary

**Features:**
- `dlopen()` → `LoadLibraryA()`
- `dlsym()` → `GetProcAddress()`
- `dlclose()` → `FreeLibrary()`
- `dlerror()` → Returns thread-local error string
- RTLD_LAZY, RTLD_NOW, RTLD_GLOBAL macros defined (values ignored, for compatibility)

**Files Modified:**
- `src/vm.cpp` - Updated to include compatibility header on Windows:
  ```cpp
  #if defined(_WIN32) || defined(WIN32)
  #include "cross-platfrom/dlfcn_compat.h"
  #else
  #include <dlfcn.h>
  #endif
  ```

#### 3. Automatic MinGW Runtime DLL Copying
**Problem:** Executables built with MinGW require runtime DLLs (`libgcc_s_seh-1.dll`, `libwinpthread-1.dll`, `libstdc++-6.dll`) which are only in PATH within MSYS environment, causing the binary to fail when run from PowerShell or Windows Command Prompt.

**Solution:**
- Added CMake post-build command to automatically copy MinGW runtime DLLs to build directory
- Executable now works from any Windows environment without requiring MSYS in PATH

**CMakeLists.txt Addition:**
```cmake
elseif(WIN32 AND MINGW)
    add_custom_command(TARGET neutron POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
            ${CMAKE_CXX_COMPILER}/../libgcc_s_seh-1.dll
            ${CMAKE_CXX_COMPILER}/../libwinpthread-1.dll
            ${CMAKE_CXX_COMPILER}/../libstdc++-6.dll
            $<TARGET_FILE_DIR:neutron>
        COMMENT "Copying MinGW runtime DLLs to build directory"
    )
endif()
```

---

## Testing Improvements

### Test Runner Enhancements
**Problem:** `run_tests.ps1` expected executable in `build/Release/` (MSVC convention) but MSYS builds place it in `build/` (Unix-style flat structure).

**Solution:**
- Simplified PowerShell test runner without color formatting (which caused file corruption)
- Automatic detection of executable in multiple locations:
  1. `build/neutron.exe` (MSYS/MinGW)
  2. `build/Release/neutron.exe` (MSVC Release)
  3. `build/Debug/neutron.exe` (MSVC Debug)
  4. `neutron.exe` (project root)
- Supports both bash (`run_tests.sh`) and PowerShell (`run_tests.ps1`) test runners

**Test Results:**
- ✅ All 26 tests passing on Windows MSYS/MinGW64
- ✅ Full test suite compatibility maintained

---

## Documentation Updates

### BUILD.md Updates
- Added note that `dlfcn-win32` is optional for Windows builds
- Clarified that internal shim is used automatically when `dlfcn-win32` not found
- Updated MSYS2 build instructions with clearer dependency list
- Added note about automatic MinGW DLL copying
- Updated vcpkg instructions to mark `dlfcn-win32` as optional

---

## Technical Details

### Build Configuration Output
When building on Windows without `dlfcn-win32`:
```
-- Could NOT find dlfcn-win32 (missing: dlfcn-win32_DIR)
-- dlfcn-win32 not found; using internal Windows shim for dlopen/dlsym/dlclose
```

When `dlfcn-win32` is installed:
```
-- Found dlfcn-win32
```
(Uses system package instead of internal shim)

### Compatibility
- **Windows:** Full support via internal shim or optional dlfcn-win32
- **Linux:** Uses system `<dlfcn.h>` and links with `-ldl` (no changes)
- **macOS:** Uses system `<dlfcn.h>` (no changes)

### Build Times
No significant impact on build times. The shim adds one small `.cpp` file compilation when used.

---

## Migration Notes

### For Existing Users
No action required. The build system automatically detects and adapts.

### For New Windows Users
1. Install MSYS2/MinGW64 or Visual Studio
2. Install dependencies: `curl`, `jsoncpp` (via pacman or vcpkg)
3. Build normally with CMake - no need for `dlfcn-win32`

### For Users with dlfcn-win32 Already Installed
No changes needed. CMake will detect and use the system package automatically.

---

## Known Issues
None identified in this release.

---

## Future Considerations
- Consider adding a CMake option to force use of system dlfcn-win32 even when internal shim is available
- Potential future enhancement: Add debug logging to show which dlopen implementation is being used

---

## Credits
- Windows compatibility shim implementation
- Build system improvements for cross-platform support
- Test runner enhancements for Windows/MSYS compatibility

---

## Files Changed

### Added
- `include/cross-platfrom/dlfcn_compat.h`
- `src/platform/dlfcn_compat_win.cpp`
- `logs/v1.0.3-alpha.md` (this file)

### Modified
- `CMakeLists.txt` - Optional dlfcn-win32, DLL copying
- `src/vm.cpp` - Conditional dlfcn.h include
- `src/main.cpp` - Version string updated to 1.0.3
- `CHANGELOG.md` - Added v1.0.3 entry
- `docs/BUILD.md` - Updated Windows build instructions
- `run_tests.ps1` - Cross-platform executable detection

### No Changes (Verified)
- All Linux/macOS build and runtime code unchanged
- Core VM, compiler, and runtime logic unchanged
- All module implementations unchanged
- Test suite unchanged (all tests still passing)

---

## Build & Test Summary

**Platforms Tested:**
- ✅ Windows 11 with MSYS2/MinGW64 (gcc 15.2.0)

**Build Status:**
- ✅ CMake configuration successful
- ✅ Compilation successful (warnings only, no errors)
- ✅ Linking successful
- ✅ Runtime DLLs copied automatically
- ✅ Executable works from PowerShell/CMD without MSYS in PATH

**Test Results:**
- ✅ 26/26 tests passing
- ✅ All modules functional (sys, math, json, http, time, convert)
- ✅ REPL functional
- ✅ Script execution functional
- ✅ Command-line arguments functional

---

## Conclusion

Version 1.0.3-alpha successfully improves Neutron's Windows build experience by removing external dependencies while maintaining full cross-platform compatibility. The internal dlfcn compatibility shim provides a robust, zero-dependency solution for dynamic loading on Windows, and the automatic DLL copying ensures executables work seamlessly across different Windows environments.
