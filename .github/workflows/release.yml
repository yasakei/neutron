name: Release

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release'
        required: true
        type: string

jobs:
  build-linux-x64:
    name: Build Linux x64 Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          pkg-config \
          libcurl4-openssl-dev \
          libjsoncpp-dev
          
    - name: Build Neutron Runtime
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
        cmake --build build
      
    - name: Build Box Package Manager
      run: |
        cmake -B nt-box/build -S nt-box -DCMAKE_BUILD_TYPE=Release
        cmake --build nt-box/build
        cp nt-box/build/box .
      
    - name: Package
      run: python3 package.py --output neutron-linux-x64

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"

    - name: Create Release Archive
      run: tar -czf neutron-${{ steps.get_version.outputs.version }}-linux-x64.tar.gz neutron-linux-x64
        
    - name: Upload Release Asset
      uses: actions/upload-artifact@v4
      with:
        name: neutron-linux-x64
        path: neutron-${{ steps.get_version.outputs.version }}-linux-x64.tar.gz


  build-macos-universal:
    name: Build macOS Universal Release
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Install dependencies
      run: |
        brew install cmake
        # Build universal jsoncpp
        git clone https://github.com/open-source-parsers/jsoncpp.git
        cd jsoncpp
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" -DBUILD_SHARED_LIBS=OFF -DJSONCPP_WITH_TESTS=OFF -DJSONCPP_WITH_POST_BUILD_UNITTEST=OFF
        sudo cmake --build build --target install
      
    - name: Build Neutron Runtime
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64"
        cmake --build build
      
    - name: Build Box Package Manager
      run: |
        cmake -B nt-box/build -S nt-box -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64"
        cmake --build nt-box/build
        cp nt-box/build/box .
      
    - name: Package
      run: python3 package.py --output neutron-macos-universal

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
        
    - name: Create Release Archive
      run: tar -czf neutron-${{ steps.get_version.outputs.version }}-macos-universal.tar.gz neutron-macos-universal

    - name: Upload Release Asset
      uses: actions/upload-artifact@v4
      with:
        name: neutron-macos-universal
        path: neutron-${{ steps.get_version.outputs.version }}-macos-universal.tar.gz


  build-windows:
    name: Build Windows x64 Release
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install NSIS
      run: |
        choco install nsis -y
      shell: pwsh

    - name: Install dependencies (vcpkg)
      run: |
        vcpkg install jsoncpp:x64-windows curl:x64-windows
        vcpkg integrate install
          
    - name: Build Neutron Runtime
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
        cmake --build build --config Release
      
    - name: Build Box Package Manager
      run: |
        cmake -B nt-box/build -S nt-box -DCMAKE_BUILD_TYPE=Release
        cmake --build nt-box/build --config Release
        copy nt-box\build\Release\box.exe .
      
    - name: Package
      run: python package.py --output neutron-windows-x64
      shell: pwsh
      
    - name: Get version
      id: get_version
      shell: bash
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
        
    - name: Create Release Archive
      run: |
        $Version = "${{ steps.get_version.outputs.version }}"
        Compress-Archive -Path neutron-windows-x64 -DestinationPath "neutron-${Version}-windows-x64.zip"
      shell: pwsh
    
    - name: Create Installer
      run: python package.py --installer
      shell: pwsh
        
    - name: Upload Release Asset (Zip)
      uses: actions/upload-artifact@v4
      with:
        name: neutron-windows-x64-zip
        path: neutron-${{ steps.get_version.outputs.version }}-windows-x64.zip

    - name: Upload Release Asset (Installer)
      uses: actions/upload-artifact@v4
      if: hashFiles('NeutronInstaller.exe') != ''
      with:
        name: neutron-windows-x64-installer
        path: NeutronInstaller.exe

  create-release:
    name: Create GitHub Release
    needs: [build-linux-x64, build-macos-universal, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.version, 'alpha') || contains(steps.get_version.outputs.version, 'beta') || contains(steps.get_version.outputs.version, 'rc') }}
        files: |
          artifacts/neutron-linux-x64/*
          artifacts/neutron-macos-universal/*
          artifacts/neutron-windows-x64-zip/*
          artifacts/neutron-windows-x64-installer/*
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
