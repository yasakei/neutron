name: Release

on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*.*.*-*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release'
        required: true
        type: string

jobs:
  build-linux-x64:
    name: Build Linux x64 Release
    runs-on: ubuntu-latest
    container: archlinux:latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Install dependencies
      run: |
        # Update package database and install dependencies
        pacman -Syu --noconfirm
        pacman -S --noconfirm \
          base-devel \
          cmake \
          gcc \
          pkgconf \
          curl \
          jsoncpp \
          python
        
        # Verify GCC version (should be 15.x)
        echo "Using GCC version:"
        gcc --version
        
        # Check jsoncpp version
        echo "Installed jsoncpp version:"
        pkg-config --modversion jsoncpp || echo "jsoncpp version not available via pkg-config"
        ls -la /usr/lib/libjsoncpp.so* || echo "jsoncpp library files not found"
          
    - name: Build Neutron Runtime
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
        cmake --build build
        cmake --build build --target neutron-lsp
        
        # Verify LSP dependencies
        echo "LSP dependencies:"
        ldd build/neutron-lsp || echo "Static binary (no dynamic dependencies)"
        
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        
    - name: Build Box Package Manager
      run: |
        cmake -B nt-box/build -S nt-box -DCMAKE_BUILD_TYPE=Release
        cmake --build nt-box/build
      
    - name: Copy binaries and libraries to root for packaging
      run: |
        cp build/neutron .
        cp nt-box/build/box .
        cp build/neutron-lsp . 2>/dev/null || echo "neutron-lsp not found in expected build dir"
        cp build/*.so . 2>/dev/null || echo "No .so files to copy"
        cp build/*.a . 2>/dev/null || echo "No .a files to copy"
      
    - name: Package
      run: python package.py --output neutron-linux-x64 --skip-build

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"

    - name: Create Release Archive
      run: tar -czf neutron-${{ steps.get_version.outputs.version }}-linux-x64.tar.gz neutron-linux-x64
        
    - name: Upload Release Asset
      uses: actions/upload-artifact@v4
      with:
        name: neutron-linux-x64
        path: neutron-${{ steps.get_version.outputs.version }}-linux-x64.tar.gz


  build-macos-arm64:
    name: Build macOS ARM64 Release
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Install dependencies
      run: |
        # Use latest GCC for best performance
        brew install cmake jsoncpp
        
        # Verify compiler version
        echo "Using compiler version:"
        clang --version
      
    - name: Build Neutron Runtime
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
        cmake --build build
        cmake --build build --target neutron-lsp
        
        # Verify LSP dependencies
        echo "LSP dependencies:"
        otool -L build/neutron-lsp || echo "Could not check dependencies"
        
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
      
    - name: Build Box Package Manager
      run: |
        cmake -B nt-box/build -S nt-box -DCMAKE_BUILD_TYPE=Release
        cmake --build nt-box/build
      
    - name: Copy binaries and libraries to root for packaging
      run: |
        cp build/neutron .
        cp nt-box/build/box .
        cp build/neutron-lsp . 2>/dev/null || echo "neutron-lsp not found"
        cp build/*.dylib . 2>/dev/null || echo "No .dylib files to copy"
        cp build/*.a . 2>/dev/null || echo "No .a files to copy"
      
    - name: Package
      run: python3 package.py --output neutron-macos-arm64 --skip-build

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
        
    - name: Create Release Archive
      run: tar -czf neutron-${{ steps.get_version.outputs.version }}-macos-arm64.tar.gz neutron-macos-arm64

    - name: Upload Release Asset
      uses: actions/upload-artifact@v4
      with:
        name: neutron-macos-arm64
        path: neutron-${{ steps.get_version.outputs.version }}-macos-arm64.tar.gz


  build-windows-zip:
    name: Build Windows x64 Zip
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install dependencies (vcpkg)
      run: |
        vcpkg install jsoncpp:x64-windows curl:x64-windows
        vcpkg integrate install
          
    - name: Build Neutron Runtime
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
        cmake --build build --config Release
      
    - name: Build Box Package Manager
      run: |
        cmake -B nt-box/build -S nt-box -DCMAKE_BUILD_TYPE=Release
        cmake --build nt-box/build --config Release
      
    - name: Copy binaries to root for packaging
      run: |
        copy build\Release\neutron.exe .
        copy nt-box\build\Release\box.exe .
        copy build\Release\*.dll . 2>nul || echo "No DLLs to copy"
        copy build\Release\*.lib . 2>nul || echo "No LIBs to copy"
      shell: cmd
      
    - name: Package
      run: python package.py --output neutron-windows-x64 --skip-build
      shell: pwsh
      
    - name: Get version
      id: get_version
      shell: bash
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
        
    - name: Create Release Archive
      run: |
        $Version = "${{ steps.get_version.outputs.version }}"
        Compress-Archive -Path neutron-windows-x64 -DestinationPath "neutron-${Version}-windows-x64.zip"
      shell: pwsh
        
    - name: Upload Release Asset (Zip)
      uses: actions/upload-artifact@v4
      with:
        name: neutron-windows-x64-zip
        path: neutron-${{ steps.get_version.outputs.version }}-windows-x64.zip

  build-windows-installer:
    name: Build Windows x64 Installer
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install NSIS
      run: |
        choco install nsis -y
        # Refresh PATH to include NSIS
        $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
        Write-Host "NSIS installed, checking version:"
        & "C:\Program Files (x86)\NSIS\makensis.exe" /VERSION
      shell: pwsh

    - name: Install dependencies (vcpkg)
      run: |
        vcpkg install jsoncpp:x64-windows curl:x64-windows
        vcpkg integrate install
          
    - name: Build Neutron Runtime
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
        cmake --build build --config Release
      
    - name: Build Box Package Manager
      run: |
        cmake -B nt-box/build -S nt-box -DCMAKE_BUILD_TYPE=Release
        cmake --build nt-box/build --config Release
      
    - name: Copy binaries and dependencies to root for installer
      run: |
        copy build\Release\neutron.exe .
        copy nt-box\build\Release\box.exe .
        copy build\Release\*.dll . 2>nul || echo "No DLLs to copy from Release"
        copy build\Release\*.lib . 2>nul || echo "No LIBs to copy from Release"
        echo "Files copied to root for installer"
      shell: cmd
      
    - name: Get version
      id: get_version
      shell: bash
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
    
    - name: List files before installer creation
      run: |
        Write-Host "=== Files in root directory ==="
        Get-ChildItem | Format-Table Name, Length, LastWriteTime
        Write-Host "`n=== Checking for required files ==="
        if (Test-Path "neutron.exe") { Write-Host "✓ neutron.exe found" } else { Write-Host "✗ neutron.exe NOT found" }
        if (Test-Path "box.exe") { Write-Host "✓ box.exe found" } else { Write-Host "✗ box.exe NOT found" }
        if (Test-Path "installer.nsi") { Write-Host "✓ installer.nsi found" } else { Write-Host "✗ installer.nsi NOT found" }
        if (Test-Path "LICENSE") { Write-Host "✓ LICENSE found" } else { Write-Host "✗ LICENSE NOT found" }
        Write-Host "`n=== Build directory contents ==="
        if (Test-Path "build/Release") {
          Get-ChildItem build/Release | Format-Table Name, Length
        }
      shell: pwsh
    
    - name: Create Installer
      run: |
        Write-Host "=== Creating Windows Installer ==="
        python package.py --installer --skip-build
        Write-Host "`n=== Checking if installer was created ==="
        if (Test-Path "NeutronInstaller.exe") {
          Write-Host "✓ NeutronInstaller.exe created successfully"
          $size = (Get-Item NeutronInstaller.exe).Length
          Write-Host "File size: $size bytes ($([math]::Round($size/1MB, 2)) MB)"
        } else {
          Write-Host "✗ NeutronInstaller.exe NOT created"
          Write-Host "`nListing all .exe files in current directory:"
          Get-ChildItem *.exe
          exit 1
        }
      shell: pwsh
        
    - name: Upload Release Asset (Installer)
      uses: actions/upload-artifact@v4
      with:
        name: neutron-windows-x64-installer
        path: NeutronInstaller.exe

  build-vscode-extension:
    name: Build VS Code Extension
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        # Remove 'v' prefix for npm version
        NPM_VERSION=${VERSION#v}
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "npm_version=${NPM_VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}, NPM Version: ${NPM_VERSION}"
        
    - name: Update extension version
      working-directory: vscode-extension
      run: |
        npm version ${{ steps.get_version.outputs.npm_version }} --no-git-tag-version --allow-same-version || true
        
    - name: Install dependencies
      working-directory: vscode-extension
      run: npm ci
      
    - name: Compile TypeScript
      working-directory: vscode-extension
      run: npm run compile
      
    - name: Package Extension
      working-directory: vscode-extension
      run: |
        npm install -g @vscode/vsce
        vsce package --no-dependencies -o neutron-${{ steps.get_version.outputs.version }}.vsix
        
    - name: Verify VSIX created
      working-directory: vscode-extension
      run: |
        ls -lh *.vsix
        echo "VS Code extension packaged successfully"
        
    - name: Upload Extension Artifact
      uses: actions/upload-artifact@v4
      with:
        name: neutron-vscode-extension
        path: vscode-extension/*.vsix

  create-release:
    name: Create GitHub Release
    needs: [build-linux-x64, build-macos-arm64, build-windows-zip, build-windows-installer, build-vscode-extension]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.tag }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: ${VERSION}"
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.version, 'alpha') || contains(steps.get_version.outputs.version, 'beta') || contains(steps.get_version.outputs.version, 'rc') }}
        files: |
          artifacts/neutron-linux-x64/*
          artifacts/neutron-macos-arm64/*
          artifacts/neutron-windows-x64-zip/*
          artifacts/neutron-windows-x64-installer/*
          artifacts/neutron-vscode-extension/*
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
