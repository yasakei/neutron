name: CI

on:
  push:
    branches: [ main, release, develop ]
  pull_request:
    branches: [ main, release, develop ]
  workflow_dispatch:

jobs:
  build-linux:
    name: Build on Ubuntu
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          pkg-config \
          libcurl4-openssl-dev \
          libjsoncpp-dev
          
    - name: Build and Package
      run: python3 package.py
      
    - name: Verify binary
      run: |
        ls -lh build/neutron
        ./build/neutron --version
        
    - name: Run tests
      run: python3 run_tests.py
      
    - name: Create Archive
      run: |
        cd release
        tar -czf ../neutron-linux-x64.tar.gz *
        cd ..
      
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: neutron-linux-x64
        path: neutron-linux-x64.tar.gz
        retention-days: 7

  build-macos-universal:
    name: Build on macOS Universal
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Install dependencies
      run: |
        brew install cmake
        # Build universal jsoncpp
        git clone https://github.com/open-source-parsers/jsoncpp.git
        cd jsoncpp
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" -DBUILD_SHARED_LIBS=OFF -DJSONCPP_WITH_TESTS=OFF -DJSONCPP_WITH_POST_BUILD_UNITTEST=OFF
        sudo cmake --build build --target install
        
    - name: Build and Package
      run: python3 package.py
      
    - name: Verify binary
      run: |
        ls -lh build/neutron
        file build/neutron
        ./build/neutron --version
        
    - name: Run tests
      run: python3 run_tests.py

    - name: Create Archive
      run: |
        cd release
        tar -czf ../neutron-macos-universal.tar.gz *
        cd ..
      
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: neutron-macos-universal
        path: neutron-macos-universal.tar.gz
        retention-days: 7

  build-windows-msvc:
    name: Build on Windows (MSVC)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install dependencies (vcpkg)
      run: |
        vcpkg install jsoncpp:x64-windows curl:x64-windows
        vcpkg integrate install
      
    - name: Build and Package
      run: python package.py
      env:
        CMAKE_TOOLCHAIN_FILE: C:/vcpkg/scripts/buildsystems/vcpkg.cmake
      
    - name: Verify binary
      run: |
        dir build\Release\neutron.exe
        .\build\Release\neutron.exe --version
        
    - name: Run tests
      run: python run_tests.py
        
    - name: Create Archive
      run: |
        Compress-Archive -Path release\* -DestinationPath neutron-windows-x64.zip
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: neutron-windows-x64
        path: neutron-windows-x64.zip
        retention-days: 7

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos-universal, build-windows-msvc]
    if: always()
    
    steps:
    - name: Check build status
      run: |
        echo "Build Summary:"
        echo "Linux: ${{ needs.build-linux.result }}"
        echo "macOS Universal: ${{ needs.build-macos-universal.result }}"
        echo "Windows: ${{ needs.build-windows-msvc.result }}"
        
    - name: Fail if any build failed
      if: |
        needs.build-linux.result != 'success' || 
        needs.build-macos-universal.result != 'success' || 
        needs.build-windows-msvc.result != 'success'
      run: exit 1
