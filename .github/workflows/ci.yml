name: CI

on:
  push:
    branches: [ main, release, develop ]
  pull_request:
    branches: [ main, release, develop ]
  workflow_dispatch:

jobs:
  build-linux:
    name: Build on Ubuntu
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          pkg-config \
          libcurl4-openssl-dev \
          libjsoncpp-dev
          
    - name: Build Neutron Runtime
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
        cmake --build build
      
    - name: Build Box Package Manager
      run: |
        cmake -B nt-box/build -S nt-box -DCMAKE_BUILD_TYPE=Release
        cmake --build nt-box/build
        cp nt-box/build/box .
      
    - name: Package
      run: python3 package.py --output neutron-linux-x64
      
    - name: Verify binaries
      run: |
        ls -lh build/neutron
        ls -lh box
        ./build/neutron --version
        ./box --version
        
    - name: Run tests
      run: python3 run_tests.py
      
    - name: Run Performance Benchmarks
      run: |
        echo "==========================================================="
        echo "  LINUX (Ubuntu) PERFORMANCE BENCHMARKS"
        echo "==========================================================="
        python3 run_benchmark.py | tee benchmark-linux.txt
        echo ""
        echo "==========================================================="
      
    - name: Upload Benchmark Results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-linux
        path: benchmark-linux.txt
        retention-days: 30
      
    - name: Create Archive
      run: tar -czf neutron-linux-x64.tar.gz neutron-linux-x64
      
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: neutron-linux-x64
        path: neutron-linux-x64.tar.gz
        retention-days: 7

  build-macos-universal:
    name: Build on macOS Universal
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Install dependencies
      run: |
        brew install cmake
        # Build universal jsoncpp
        git clone https://github.com/open-source-parsers/jsoncpp.git
        cd jsoncpp
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" -DBUILD_SHARED_LIBS=OFF -DJSONCPP_WITH_TESTS=OFF -DJSONCPP_WITH_POST_BUILD_UNITTEST=OFF
        sudo cmake --build build --target install
        
    - name: Build Neutron Runtime
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64"
        cmake --build build
      
    - name: Build Box Package Manager
      run: |
        cmake -B nt-box/build -S nt-box -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64"
        cmake --build nt-box/build
        cp nt-box/build/box .
      
    - name: Package
      run: python3 package.py --output neutron-macos-universal
      
    - name: Verify binaries
      run: |
        ls -lh build/neutron
        ls -lh box
        file build/neutron
        file box
        ./build/neutron --version
        ./box --version
        
    - name: Run tests
      run: python3 run_tests.py

    - name: Run Performance Benchmarks
      run: |
        echo "==========================================================="
        echo "  macOS (Apple Silicon) PERFORMANCE BENCHMARKS"
        echo "==========================================================="
        python3 run_benchmark.py | tee benchmark-macos.txt
        echo ""
        echo "==========================================================="
      
    - name: Upload Benchmark Results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-macos
        path: benchmark-macos.txt
        retention-days: 30

    - name: Create Archive
      run: tar -czf neutron-macos-universal.tar.gz neutron-macos-universal
      
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: neutron-macos-universal
        path: neutron-macos-universal.tar.gz
        retention-days: 7

  build-windows-msvc:
    name: Build on Windows (MSVC)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install dependencies (vcpkg)
      run: |
        vcpkg install jsoncpp:x64-windows curl:x64-windows
        vcpkg integrate install
      
    - name: Build Neutron Runtime
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
        cmake --build build --config Release
      
    - name: Build Box Package Manager
      run: |
        cmake -B nt-box/build -S nt-box -DCMAKE_BUILD_TYPE=Release
        cmake --build nt-box/build --config Release
        copy nt-box\build\Release\box.exe .
      
    - name: Package
      run: python package.py --output neutron-windows-x64
      
    - name: Verify binaries
      run: |
        dir build\Release\neutron.exe
        dir box.exe
        .\build\Release\neutron.exe --version
        .\box.exe --version
        
    - name: Run tests
      run: python run_tests.py

    - name: Run Performance Benchmarks
      run: |
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        $env:PYTHONIOENCODING = "utf-8"
        Write-Host "==========================================================="
        Write-Host "  WINDOWS (x64) PERFORMANCE BENCHMARKS"
        Write-Host "==========================================================="
        python run_benchmark.py | Tee-Object -FilePath benchmark-windows.txt
        Write-Host ""
        Write-Host "==========================================================="
      
    - name: Upload Benchmark Results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-windows
        path: benchmark-windows.txt
        retention-days: 30
        
    - name: Create Archive
      run: |
        Compress-Archive -Path neutron-windows-x64 -DestinationPath neutron-windows-x64.zip
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: neutron-windows-x64
        path: neutron-windows-x64.zip
        retention-days: 7

  build-vscode-extension:
    name: Build VS Code Extension
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      working-directory: vscode-extension
      run: npm ci
      
    - name: Compile TypeScript
      working-directory: vscode-extension
      run: npm run compile
      
    - name: Package Extension
      working-directory: vscode-extension
      run: |
        npm install -g @vscode/vsce
        vsce package --no-dependencies
        
    - name: Verify VSIX created
      working-directory: vscode-extension
      run: |
        ls -lh *.vsix
        echo "VS Code extension packaged successfully"
        
    - name: Upload Extension Artifact
      uses: actions/upload-artifact@v4
      with:
        name: vscode-extension
        path: vscode-extension/*.vsix
        retention-days: 7

  benchmark-summary:
    name: Performance Summary
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos-universal, build-windows-msvc]
    if: always()
    
    steps:
    - name: Download all benchmark results
      uses: actions/download-artifact@v4
      with:
        pattern: benchmark-*
        merge-multiple: true
        
    - name: Generate Performance Summary
      run: |
        echo ""
        echo "+====================================================================+"
        echo "|           NEUTRON PERFORMANCE SUMMARY (ALL PLATFORMS)              |"
        echo "+====================================================================+"
        echo ""
        
        echo "+--------------------------------------------------------------------+"
        echo "| LINUX RESULTS                                                      |"
        echo "+--------------------------------------------------------------------+"
        if [ -f benchmark-linux.txt ]; then
          cat benchmark-linux.txt | grep -E "(Win Rate|Neutron Faster|Python Faster|SUMMARY)" || cat benchmark-linux.txt | tail -20
        else
          echo "  Linux benchmark results not available"
        fi
        echo ""
        
        echo "+--------------------------------------------------------------------+"
        echo "| macOS RESULTS                                                      |"
        echo "+--------------------------------------------------------------------+"
        if [ -f benchmark-macos.txt ]; then
          cat benchmark-macos.txt | grep -E "(Win Rate|Neutron Faster|Python Faster|SUMMARY)" || cat benchmark-macos.txt | tail -20
        else
          echo "  macOS benchmark results not available"
        fi
        echo ""
        
        echo "+--------------------------------------------------------------------+"
        echo "| WINDOWS RESULTS                                                    |"
        echo "+--------------------------------------------------------------------+"
        if [ -f benchmark-windows.txt ]; then
          cat benchmark-windows.txt | grep -E "(Win Rate|Neutron Faster|Python Faster|SUMMARY)" || cat benchmark-windows.txt | tail -20
        else
          echo "  Windows benchmark results not available"
        fi
        echo ""
        echo "====================================================================="

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos-universal, build-windows-msvc, build-vscode-extension]
    if: always()
    
    steps:
    - name: Check build status
      run: |
        echo "Build Summary:"
        echo "Linux: ${{ needs.build-linux.result }}"
        echo "macOS Universal: ${{ needs.build-macos-universal.result }}"
        echo "Windows: ${{ needs.build-windows-msvc.result }}"
        echo "VS Code Extension: ${{ needs.build-vscode-extension.result }}"
        
    - name: Fail if any build failed
      if: |
        needs.build-linux.result != 'success' || 
        needs.build-macos-universal.result != 'success' || 
        needs.build-windows-msvc.result != 'success' ||
        needs.build-vscode-extension.result != 'success'
      run: exit 1
