name: CI

on:
  push:
    branches: [ main, release, develop ]
  pull_request:
    branches: [ main, release, develop ]
  workflow_dispatch:

jobs:
  build-linux:
    name: Build on Arch Linux
    runs-on: ubuntu-latest
    container: archlinux:latest
    
    steps:
    - name: Install Git (required for checkout with submodules)
      run: |
        pacman -Sy --noconfirm git
    
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Install dependencies
      run: |
        # Update package database and install dependencies
        pacman -Syu --noconfirm
        pacman -S --noconfirm \
          base-devel \
          cmake \
          gcc \
          pkgconf \
          curl \
          jsoncpp \
          python
        
        # Verify GCC version (should be 15.x)
        echo "Using GCC version:"
        gcc --version
        
        # Check jsoncpp version
        echo "Installed jsoncpp version:"
        pkg-config --modversion jsoncpp || echo "jsoncpp version not available via pkg-config"
        ls -la /usr/lib/libjsoncpp.so* || echo "jsoncpp library files not found"
          
    - name: Build Neutron Runtime
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
        cmake --build build
      
    - name: Build Box Package Manager
      run: |
        cmake -B nt-box/build -S nt-box -DCMAKE_BUILD_TYPE=Release
        cmake --build nt-box/build
        cp nt-box/build/box .
      
    - name: Package
      run: python package.py --output neutron-linux-x64 --skip-build
      
    - name: Verify binaries
      run: |
        ls -lh build/neutron
        ls -lh box
        ./build/neutron --version
        ./box --version
        
    - name: Run tests
      run: python3 run_tests.py
      
    - name: Install Neutron globally
      run: |
        # Dependencies are already installed from the build step
        # Install neutron and box to system PATH
        sudo cp build/neutron /usr/local/bin/
        sudo cp box /usr/local/bin/
        sudo chmod +x /usr/local/bin/neutron
        sudo chmod +x /usr/local/bin/box
        
        # Install include files needed for neutron build
        sudo cp -r include /usr/local/
        
        # Install source files needed for runtime compilation  
        sudo cp -r src /usr/local/
        sudo cp -r libs /usr/local/
        
        # Create lib directory if it doesn't exist
        sudo mkdir -p /usr/local/lib
        
        # Install runtime libraries (essential for linking)
        if [ -f "build/libneutron_runtime.a" ]; then
          sudo cp build/libneutron_runtime.a /usr/local/lib/
        fi
        if [ -f "build/libneutron_shared.so" ]; then
          sudo cp build/libneutron_shared.so /usr/local/lib/
        fi
        if [ -f "build/libneutron_shared.dylib" ]; then
          sudo cp build/libneutron_shared.dylib /usr/local/lib/
        fi
        
        # Update library cache on Linux
        if [[ "$OSTYPE" == "linux-gnu"* ]]; then
          sudo ldconfig
        fi
        
        # Verify global installation
        which neutron
        which box
        neutron --version
        box --version
        
    - name: Test Neutron Integration
      run: |
        # Create a temporary test directory
        mkdir -p /tmp/neutron-integration-test/test-project
        cd /tmp/neutron-integration-test/test-project
        
        echo "Testing neutron init..."
        neutron init test
        
        echo "Testing box install base64..."
        box install base64
        
        echo "Testing neutron build..."
        neutron build
        
        echo "Integration tests completed successfully!"
      
    - name: Run Performance Benchmarks
      run: |
        echo "==========================================================="
        echo "  LINUX (Ubuntu) PERFORMANCE BENCHMARKS"
        echo "==========================================================="
        python3 run_benchmark.py | tee benchmark-linux.txt
        echo ""
        echo "==========================================================="
      
    - name: Upload Benchmark Results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-linux
        path: benchmark-linux.txt
        retention-days: 30
      
    - name: Create Archive
      run: tar -czf neutron-linux-x64.tar.gz neutron-linux-x64
      
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: neutron-linux-x64
        path: neutron-linux-x64.tar.gz
        retention-days: 7

  build-macos-arm64:
    name: Build on macOS (Apple Silicon)
    runs-on: macos-14
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
      
    - name: Install dependencies
      run: |
        brew install cmake jsoncpp
        
    - name: Build Neutron Runtime
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release
        cmake --build build
      
    - name: Build Box Package Manager
      run: |
        cmake -B nt-box/build -S nt-box -DCMAKE_BUILD_TYPE=Release
        cmake --build nt-box/build
        cp nt-box/build/box .
      
    - name: Package
      run: python package.py --output neutron-macos-arm64 --skip-build
      
    - name: Verify binaries
      run: |
        ls -lh build/neutron
        ls -lh box
        file build/neutron
        file box
        ./build/neutron --version
        ./box --version
        
    - name: Run tests
      run: python3 run_tests.py

    - name: Install Neutron globally
      run: |
        # Dependencies are already installed from the build step
        # Install neutron and box to system PATH
        sudo cp build/neutron /usr/local/bin/
        sudo cp box /usr/local/bin/
        sudo chmod +x /usr/local/bin/neutron
        sudo chmod +x /usr/local/bin/box
        
        # Install include files needed for neutron build
        sudo cp -r include /usr/local/
        
        # Install source files needed for runtime compilation  
        sudo cp -r src /usr/local/
        sudo cp -r libs /usr/local/
        
        # Create lib directory if it doesn't exist
        sudo mkdir -p /usr/local/lib
        
        # Install runtime libraries (essential for linking)
        if [ -f "build/libneutron_runtime.a" ]; then
          sudo cp build/libneutron_runtime.a /usr/local/lib/
        fi
        if [ -f "build/libneutron_shared.so" ]; then
          sudo cp build/libneutron_shared.so /usr/local/lib/
        fi
        if [ -f "build/libneutron_shared.dylib" ]; then
          sudo cp build/libneutron_shared.dylib /usr/local/lib/
        fi
        
        # On macOS, create symlinks to Homebrew libraries so neutron build can find them
        if [[ "$OSTYPE" == "darwin"* ]]; then
          # Find Homebrew prefix (Apple Silicon vs Intel)
          if [ -d "/opt/homebrew" ]; then
            BREW_PREFIX="/opt/homebrew"
          else
            BREW_PREFIX="/usr/local"
          fi
          
          # Create symlinks for jsoncpp and curl libraries
          if [ -f "$BREW_PREFIX/lib/libjsoncpp.dylib" ]; then
            sudo ln -sf "$BREW_PREFIX/lib/libjsoncpp.dylib" /usr/local/lib/libjsoncpp.dylib
          fi
          if [ -f "$BREW_PREFIX/lib/libcurl.dylib" ]; then
            sudo ln -sf "$BREW_PREFIX/lib/libcurl.dylib" /usr/local/lib/libcurl.dylib
          fi
          
          echo "Created symlinks for Homebrew libraries"
        fi
        
        # Update library cache on Linux
        if [[ "$OSTYPE" == "linux-gnu"* ]]; then
          sudo ldconfig
        fi
        
        # Verify global installation
        which neutron
        which box
        neutron --version
        box --version
        
    - name: Test Neutron Integration
      run: |
        # Create a temporary test directory
        mkdir -p /tmp/neutron-integration-test/test-project
        cd /tmp/neutron-integration-test/test-project
        
        echo "Testing neutron init..."
        neutron init test
        
        echo "Testing box install base64..."
        box install base64
        
        echo "Testing neutron build..."
        neutron build
        
        echo "Integration tests completed successfully!"

    - name: Run Performance Benchmarks
      run: |
        echo "==========================================================="
        echo "  macOS (Apple Silicon) PERFORMANCE BENCHMARKS"
        echo "==========================================================="
        python3 run_benchmark.py | tee benchmark-macos-arm64.txt
        echo ""
        echo "==========================================================="
      
    - name: Upload Benchmark Results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-macos-arm64
        path: benchmark-macos-arm64.txt
        retention-days: 30

    - name: Create Archive
      run: tar -czf neutron-macos-arm64.tar.gz neutron-macos-arm64
      
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: neutron-macos-arm64
        path: neutron-macos-arm64.tar.gz
        retention-days: 7



  build-windows-msvc:
    name: Build on Windows (MSVC)
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install dependencies (vcpkg)
      run: |
        vcpkg install jsoncpp:x64-windows curl:x64-windows
        vcpkg integrate install
        echo "VCPKG_ROOT: $env:VCPKG_ROOT"
        echo "Checking vcpkg paths:"
        if (Test-Path "C:\vcpkg\scripts\buildsystems\vcpkg.cmake") { echo "Found at C:\vcpkg" }
        if (Test-Path "$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake") { echo "Found at VCPKG_ROOT" }
      
    - name: Build Neutron Runtime
      run: |
        $vcpkgPath = if (Test-Path "C:\vcpkg\scripts\buildsystems\vcpkg.cmake") { "C:\vcpkg\scripts\buildsystems\vcpkg.cmake" } else { "$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" }
        echo "Using vcpkg toolchain: $vcpkgPath"
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE="$vcpkgPath"
        cmake --build build --config Release
      
    - name: Build Box Package Manager
      run: |
        cmake -B nt-box/build -S nt-box -DCMAKE_BUILD_TYPE=Release
        cmake --build nt-box/build --config Release
        copy nt-box\build\Release\box.exe .
      
    - name: Package
      run: python package.py --output neutron-windows-x64 --skip-build
      
    - name: Verify binaries
      run: |
        dir build\Release\neutron.exe
        dir box.exe
        .\build\Release\neutron.exe --version
        .\box.exe --version
        
    - name: Run tests
      run: python run_tests.py

    - name: Install Neutron globally (Windows)
      run: |
        # Create a proper directory structure that neutron expects
        $neutronRoot = "C:\neutron"
        $neutronBin = "$neutronRoot\bin"
        New-Item -ItemType Directory -Force -Path $neutronBin
        
        # Copy binaries to bin subdirectory
        Copy-Item "build\Release\neutron.exe" "$neutronBin\neutron.exe"
        Copy-Item "box.exe" "$neutronBin\box.exe"
        if (Test-Path "build\Release\neutron-lsp.exe") {
            Copy-Item "build\Release\neutron-lsp.exe" "$neutronBin\neutron-lsp.exe"
        }
        
        # Copy shared runtime DLL to bin directory (essential for neutron build)
        if (Test-Path "build\Release\neutron_shared.dll") {
            Copy-Item "build\Release\neutron_shared.dll" "$neutronBin\neutron_shared.dll"
        }
        
        # Install include files in the expected location (relative to bin/../include)
        Copy-Item -Recurse "include" "$neutronRoot\include"
        
        # Install source files needed for runtime compilation
        Copy-Item -Recurse "src" "$neutronRoot\src"
        Copy-Item -Recurse "libs" "$neutronRoot\libs"
        
        # Copy runtime libraries to bin directory for linking
        if (Test-Path "build\Release\neutron_runtime.lib") {
            Copy-Item "build\Release\neutron_runtime.lib" "$neutronBin\neutron_runtime.lib"
        }
        if (Test-Path "build\Release\neutron_shared.lib") {
            Copy-Item "build\Release\neutron_shared.lib" "$neutronBin\neutron_shared.lib"
        }
        
        # Copy vcpkg DLLs if available
        $vcpkgBin = "build\vcpkg_installed\x64-windows\bin"
        if (Test-Path $vcpkgBin) {
            Get-ChildItem "$vcpkgBin\*.dll" | ForEach-Object {
                Copy-Item $_.FullName "$neutronBin\"
            }
        }
        
        # Copy vcpkg libs for linking
        $vcpkgLib = "build\vcpkg_installed\x64-windows\lib"
        if (Test-Path $vcpkgLib) {
            Get-ChildItem "$vcpkgLib\*.lib" | ForEach-Object {
                Copy-Item $_.FullName "$neutronBin\"
            }
        }
        
        # Add bin directory to PATH for this session
        $env:PATH = "$neutronBin;$env:PATH"
        
        # Verify installation
        neutron.exe --version
        box.exe --version
        
    - name: Test Neutron Integration (Windows)
      run: |
        # Set PATH for this step
        $neutronBin = "C:\neutron\bin"
        $env:PATH = "$neutronBin;$env:PATH"
        
        # Create a temporary test directory
        $testDir = "C:\temp\neutron-integration-test\test-project"
        New-Item -ItemType Directory -Force -Path $testDir
        Set-Location $testDir
        
        Write-Host "Current directory: $(Get-Location)"
        Write-Host "PATH: $env:PATH"
        Write-Host "Checking if neutron.exe is accessible..."
        neutron.exe --version
        
        Write-Host "Testing neutron init..."
        neutron.exe init test
        
        Write-Host "Listing files after init..."
        Get-ChildItem
        
        Write-Host "Testing box install base64..."
        box.exe install base64
        
        Write-Host "Testing neutron build..."
        neutron.exe build
        
        Write-Host "Integration tests completed successfully!"

    - name: Run Performance Benchmarks
      run: |
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        $env:PYTHONIOENCODING = "utf-8"
        Write-Host "==========================================================="
        Write-Host "  WINDOWS (x64) PERFORMANCE BENCHMARKS"
        Write-Host "==========================================================="
        python run_benchmark.py | Tee-Object -FilePath benchmark-windows.txt
        Write-Host ""
        Write-Host "==========================================================="
      
    - name: Upload Benchmark Results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-windows
        path: benchmark-windows.txt
        retention-days: 30
        
    - name: Create Archive
      run: |
        Compress-Archive -Path neutron-windows-x64 -DestinationPath neutron-windows-x64.zip
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: neutron-windows-x64
        path: neutron-windows-x64.zip
        retention-days: 7

  build-vscode-extension:
    name: Build VS Code Extension
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      working-directory: vscode-extension
      run: npm ci
      
    - name: Compile TypeScript
      working-directory: vscode-extension
      run: npm run compile
      
    - name: Package Extension
      working-directory: vscode-extension
      run: |
        npm install -g @vscode/vsce
        vsce package --no-dependencies
        
    - name: Verify VSIX created
      working-directory: vscode-extension
      run: |
        ls -lh *.vsix
        echo "VS Code extension packaged successfully"
        
    - name: Upload Extension Artifact
      uses: actions/upload-artifact@v4
      with:
        name: vscode-extension
        path: vscode-extension/*.vsix
        retention-days: 7

  benchmark-summary:
    name: Performance Summary
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos-arm64, build-windows-msvc]
    if: always()
    
    steps:
    - name: Download all benchmark results
      uses: actions/download-artifact@v4
      with:
        pattern: benchmark-*
        merge-multiple: true
        
    - name: Generate Performance Summary
      run: |
        echo ""
        echo "+====================================================================+"
        echo "|           NEUTRON PERFORMANCE SUMMARY (ALL PLATFORMS)              |"
        echo "+====================================================================+"
        echo ""
        
        echo "+--------------------------------------------------------------------+"
        echo "| LINUX RESULTS                                                      |"
        echo "+--------------------------------------------------------------------+"
        if [ -f benchmark-linux.txt ]; then
          cat benchmark-linux.txt | grep -E "(Win Rate|Neutron Faster|Python Faster|SUMMARY)" || cat benchmark-linux.txt | tail -20
        else
          echo "  Linux benchmark results not available"
        fi
        echo ""
        
        echo "+--------------------------------------------------------------------+"
        echo "| macOS (Apple Silicon) RESULTS                                      |"
        echo "+--------------------------------------------------------------------+"
        if [ -f benchmark-macos-arm64.txt ]; then
          cat benchmark-macos-arm64.txt | grep -E "(Win Rate|Neutron Faster|Python Faster|SUMMARY)" || cat benchmark-macos-arm64.txt | tail -20
        else
          echo "  macOS (ARM64) benchmark results not available"
        fi
        echo ""
        
        echo "+--------------------------------------------------------------------+"
        echo "| WINDOWS RESULTS                                                    |"
        echo "+--------------------------------------------------------------------+"
        if [ -f benchmark-windows.txt ]; then
          cat benchmark-windows.txt | grep -E "(Win Rate|Neutron Faster|Python Faster|SUMMARY)" || cat benchmark-windows.txt | tail -20
        else
          echo "  Windows benchmark results not available"
        fi
        echo ""
        echo "====================================================================="

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos-arm64, build-windows-msvc, build-vscode-extension]
    if: always()
    
    steps:
    - name: Check build status
      run: |
        echo "Build Summary:"
        echo "Linux: ${{ needs.build-linux.result }}"
        echo "macOS ARM64: ${{ needs.build-macos-arm64.result }}"
        echo "Windows: ${{ needs.build-windows-msvc.result }}"
        echo "VS Code Extension: ${{ needs.build-vscode-extension.result }}"
        
    - name: Fail if any build failed
      if: |
        needs.build-linux.result != 'success' || 
        needs.build-macos-arm64.result != 'success' || 
        needs.build-windows-msvc.result != 'success' ||
        needs.build-vscode-extension.result != 'success'
      run: exit 1
